

# 1.Tổng quan về Neutron

## 1.1 Openstack networking - Neutron

- Trong Openstack, Networking Service cung cấp cho người dùng API cho người dùng có thể cài đặt và định nghĩa các network. Code-name của Openstack Networking là neutron.
- Openstack networking service làm nhiệm vụ  tạo và quản lý hạ tầng mạng ảo,  bao gồm network, switch, subnet, router
- Openstack networking bao gồm : neutron-server, database storage, plug-in agent, cung cấp một số service khác để giao tiếp với Linux, external devices, or SDN controllers.
- Openstack là hoàn toàn độc lập và có triển khai trên 1 host đọc lập
- Openstack Networking tích hợp với một số copoment khác :
	- Openstack Indentify : để xác thực và ủy quyền cho các API Request
	- Openstack Compute : liên hệ với compute để gắn mỗi VNIC đến từng máy ảo riêng
	- Openstack dashboard : người dùng sử dụng để khởi tạo và quản lý các network

Openstack networking bao gồm các thành phần:
- **neutron-server** : Chấp nhận và chuyển hướng các API request đến các plugin thích hợp để xử lý.

- **Openstack Networking plug-in và agent** : Có chức năng cắm và gỡ port, tạo mạng hoặc subnet, và cung cấp các địa chỉ IP. Các plug-in hay agent sẽ khác phụ thuộc vào nhà cung cấp và các công nghệ được sử dụng trong một môi trường điện toán đám mây cụ thể. Một số agent hoặc plug-in mà neutron cung cấp ví dụ như switch ảo hoặc cứng của Cisco, NEC OpenFlow products, Open vSwitch, Linux bridging, và VMware NSX product. Các agent phổ biến là *L3 agent*(layer 3) và *DHCP agent* và plugin agent.

- **Messaging queue** : Được sử dụng để giao tiếp, truyền lệnh và trao đổi thông tin giữa neutron-server với các agent. Nó cũng hoạt động như là một database để lưu trữ trạng thái mạng cho các plug-in cụ thể.


## 1.2. Các loại network trong Openstack Networking

Trong Openstack có 3 loại network gồm : provider,  Routed provider networks và self-service


### 1.2.1. Provider Network

Provider network cung cấp kết nối mạng layer 2 cho máy ảo với tùy chọn dịch vụ DHCP và metadata. Mạng này kết nối đến mạng layer 2 đã tồn tại ở datacenter, thường dùng Vlan để định danh và chia mạng.

Provider network cung cấp sự đơn giản, hiệu năng và độ tin cậy. Chỉ có Admin user mới có quyền chỉnh sửa Provider network vì nó yêu cầu cấu hình hạ tầng mạng vật lý.

Vì Provider network cung cấp kết nối mạng ở layer 2, do đó nó thiếu đi hỗ trợ các tính năng như router hay floating ip.

Việc sử dụng các thành phần của Openstack Networking để xử lý các hoạt động ở layer-3 sẽ làm ảnh hưởng khá nhiều đến hiệu năng và độ tin cậy của hệ thống. Sử dụng mạng provider, chỉ quản lý mạng layer-2, sẽ chuyển tất cả hoạt động layer-3 cho hạ tầng mạng vật lý xử lý để tăng hiệu năng và độ tin cậy.

Chỉ có người quản trị có thể cấu hình mạng provider.

### 1.2.2. Routed Network 

Routed provider networks cung cấp kết nối ở layer 3 cho các máy ảo. Các network này map với những networks layer 3 đã tồn tại.

Cụ thể hơn , mạng này map tới các các mạng layer 2 đã được chỉ định làm provider network . Mỗi router có một gateway để làm nhiệm vụ định tuyến . . Routed provider networks tất nhiên sẽ có hiệu suất thấp hơn so với provider networks.

### 1.2.3. Self-service network

- Self-service network cho phép các project quản lý các mạng mà không cần quyền admin. Những mạng này hoàn toàn là mạng ảo và yêu cầu một mạng ảo ,sau đó tương tác với provider network và mạng ngoài ( internet ). Self-service thường sử dụng DHCP và meta cho các instance
- Mong nhiều trường hợp, self-service network sử dụng overload protocol bằng VXLAN, GRE vì chúng có thể hỗ trợ nhiều mạng hơn layer-2 khi sử dụng VLAN ( 802.1q) 
- IPv4 trong self-service thường sử dụng IP Private  ( RFC 1918 )  và tương tác với provider network bằng Source NAT sử dụng router ảo. Floating IP address cho phép truy cập instance từ provider network bằng Destination NAT sử dụng Router ảo 
- IPv6 trong self-service sử dụng IP Public và tương tác với provider network sử dụng các static route thông qua các Router ảo
- Trong openstack networking tích hợp một router layer-3 thường nằm ít nhất trên một node network. Trái ngược với provider network kết nối tới các instance thông qua hạ tầng mạng vật lý layer-2
- Người dùng có thể tạo các selt-network theo từng project.  Bởi vậy các kết nối sẽ không được chia sẻ với  các project khác. 

Trong Openstack hỗ trợ các kiểu cô lập và overplay sau :
- Flat : tất cả instance kết nối vào một network chung. Không được tag VLAN_ID vào packet hoặc phân chia vùng mạng 
- VLAN :  cho phép khởi tạo nhiều provider hoặc tenant network2 sử dụng VLAN (801.2q) , tương ứng với VLAN  đang có sẵn trên mạng vật lý. Điều này cho phép instance kết nối tới các thành phần khác trong mạng
- GRE and VXLAN : là mỗi giao thức đóng gói packet , cho phép tạo ra mạng overlay để tạo kết nối giữa các instance.  Một router ảo để kết nối từ tenant network ra external network.  Một router provider sử dụng để kết nối từ external network vào các instance trong tenant network sử dụng floating IP

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.01.png">

### 1.2.4. Một số khái niệm bổ sung 

- **Subnet** : mà một block có thể sử dụng cho host và các địa chỉ liên quan . Subnet được sử dụng để gắn các địa chỉ IP khi một port được khởi tạo
- **Subnet pool** : 
	- enduser có thể tạo các subnet và các địa chỉ IP hợp lý trong subnet đó. Tuy nhiên, mạng tenant nên được cấu hình các subnet trước mà tự gắn vào các port
	- Sử dụng **subnet pools** sẽ hạn chế những địa chỉ nào có thể sử dụng bằng cách yêu cầu mọi subnet phải nằm trong pool được xác định. Sử  dụng nhiều subnet pool trên một subnet
	- Ports : là một điểm kết nối để gắn vào một thiết bị, chẳng hạn từ một Virtual NIC đến một virtual network. Port cũng mô tả các cấu hình liên quan như MAC và IP sử dụng trên node đó
	
  <img src="https://github.com/lean15998/Openstack/blob/main/images/07.02.png">
  
	- Router : cung cấp một thiết bị layer-3 giống như thiết bị định tuyến  sử dụng NAT giữa sefl-service và provider network hoặc giữa các sefl-service network trên nhiều project . Networking service sử dụng layer-3 agent để quản lý router thông qua namespace 
- **Security Group** : 
		 -   **Security groups** cung cấp vùng lưu trữ cho _virtual firewall rules_ để kiểm soát lưu lượng truy cập ingress (inbound to instance) và egress (outbound from instance) mạng ở mức port. **Security groups** sử dụng default deny policy và chỉ chứa các rules đồng ý phép lưu lượng cụ thể. Firewall driver chuyển các _group rule_ đến cấu hình cùng cơ chế lọc gói tin như `iptables`. 
		 -  Mỗi project có chứa 1  `default`  security group mà cho phép tát cả lưu lượng egress và từ chối tất cả các lưu lượng ingress. Bạn có thể thay đổi rules trong  `default`  security group. Nó bạn launch instance mà không có security group chỉ định,  `default`  security group sẽ tự động được áp dụng cho instance đó. Tương tự, nếu bạn tạo 1 port mà không chỉ định security group,  `default`  security group tự động được áp cho port đó.
		- Mặc định khi một gói tin gửi đến không gồm trường IP nhưng default group sẽ ngăn chạn các bản tin ARP
		- Mặc định, mọi security groups chứa các rules thực hiện một số hành động sau:
			-   Cho phép traffic ra bên ngoài chỉ khi nó sử dụng địa chỉ MAC và IP của port máy ảo, cả hai địa chỉ này được kết hợp tại  `allowed-address-pairs`
			-   Cho phép tín hiệu tìm kiếm DHCP và gửi message request sử dụng MAC của port cho máy ảo và địa chỉ IP chưa xác định.
		-   Cho phép trả lời các tín hiệu DHCP và DHCPv6 từ DHCP server để các máy ảo có thể lấy IP
		-   Từ chối việc trả lời các tín hiệu DHCP request từ bên ngoài để tránh việc máy ảo trở thành DHCP server
		-   Cho phép các tín hiệu inbound/outbound ICMPv6 MLD, tìm kiếm neighbors, các máy ảo nhờ vậy có thể tìm kiếm và gia 		nhập các multicast group.
		-   Từ chối các tín hiệu outbound ICMPv6 để ngăn việc máy ảo trở thành IPv6 router và forward các tín hiệu cho máy ảo khác.
		-   Cho phép tín hiệu outbound non-IP từ địa chỉ MAC của các port trên máy ảo .
- **DHCP** : 
		- quản lý các địa chỉ IP cho provider và sefl-service network . Networking service sử dụng manages  ``qdhcp``  namespaces và   ``dnsmasq``  service. 

- **L3 Agent**

L3 agent là một phần của package openstack-neutron. Nó được xem như router layer-3 chuyển hướng lưu lượng và cung cấp dịch vụ gateway cho network lớp 2. Các nodes chạy L3 agent không được cấu hình IP trực tiếp trên một card mạng. Thay vì thế, sẽ có một dải địa chỉ IP từ mạng ngoài được sử dụng cho OpenStack networking. Các địa chỉ này được gán cho các routers mà cung cấp liên kết giữa mạng trong và mạng ngoài. Miền địa chỉ được lựa chọn phải đủ lớn để cung cấp địa chỉ IP duy nhất cho mỗi router khi triển khai cũng như mỗi floating IP gán cho các máy ảo.

-   **DHCP Agent:**  OpenStack Networking DHCP agent chịu trách nhiệm cấp phát các địa chỉ IP cho các máy ảo chạy trên network. Nếu agent được kích hoạt và đang hoạt động khi một subnet được tạo, subnet đó mặc định sẽ được kích hoạt DHCP.
-   **Plugin Agent:**  Nhiều networking plug-ins được sử dụng cho agent của chúng, bao gồm OVS và Linux bridge. Các plug-in chỉ định agent chạy trên các node đang quản lý lưu lượng mạng, bao gồm các compute node, cũng như các nodes chạy các agent.

## 1.3. Cấu trúc thành phần và dịch vụ 

### Server

Cung cấp API, quản lí database,...

### Plug-ins

Quản lí agents

###  Agents

-   Cung cấp kết nối layer 2/3 tới máy ảo
-   Xử lý truyền thông giữa mạng ảo và mạng vật lý.
-   Xử lý metadata, etc.

### Layer 2 (Ethernet and Switching)

-   Linux Bridge
-   OVS

#### Layer 3 (IP and Routing)

-   L3
-   DHCP

### Miscellaneous

-   Metadata

### Services

Các dịch vụ Routing

-   VPNaaS: Virtual Private Network-as-a-Service (VPNaaS), extension của neutron cho VPN
-   LBaaS: Load-Balancer-as-a-Service (LBaaS), API quy định và cấu hình nên các load balancers, được triển khai dựa trên HAProxy software load balancer.
-   FWaaS: Firewall-as-a-Service (FWaaS), API thử nghiệm cho phép các nhà cung cấp kiểm thử trên networking của họ.


# 2. Tìm hiểu Namepsace , DHCP, Agent và kiến trúc của Neutron

## 2.1. Network Namespace.

- **Namespace** được sử dụng để cô lập, khoanh vùng các định danh - các định danh ở đây có thể là process id, routing table, mount point, user id.  

- Ví dụ, Linux cung cấp các namespace cho mạng(network namespace), các tiến trình, và một số thứ khác. Khi một tiến trình màn chạy trong một namespace, nó chỉ có thể thấy và giao tiếp với các tiến trình khác trong cùng namespace đó. Ví dụ một tiến trình bash ở trong một name space, khi chạy lệnh `ps waux`, nó sẽ chỉ hiển thị các tiến trình trong cùng namespace đó.

### Linux network namespace.

- Trong một network namespace, định danh được khoanh vùng phạm vi ở đây là các thiết bị mạng; Các thiết bị mạng trên hệ thống nếu không có cấu hình đặc biệt nào thì nó sẽ nằm cùng trên một network namespace mặc định. Các thiết bị mạng có thể được tạo, xóa hoặc chuyển từ namespace này sang namespace khác. 

- Mỗi network namespace có một routing table riêng.

- Mỗi namespace có một bảng các rule iptables riêng(cả IPv4 lẫn IPv6).

- Bất kỳ tiến trình Linux cụ thể nào cũng chạy trên một network namespace cụ thể.  Mặc định, nó sẽ thừa hưởng namespace từ tiến trình cha, như một tiến trình có khả năng phù hợp có thể tự chuyển nó sang một network namespace khác.(thường được sử dụng với câu lệnh `ip netns exec NETNS COMMAND...`).
### Lợi ích của Namespace

- **Overlapping IPs**: Một lợi ích lớn của việc triển khai namespace trong Neutron là các người dùng có thể tạo các địa chỉ IP chồng chéo, điều này đem lại sự tự do cho người dùng cloud vì họ có thể tự do tạo bất kỳ subnet nào mà không sợ bị trùng dải địa chỉ với người dùng khác. 

- *Linux Network Namespace* được yêu cầu cho node mà chạy *neutron-l3-agent* hoặc *neutron-dhcp-agent* nếu overlapping IPs được sử dụng.

- **L3 agent**: neutron-l3-agent được thiết kế để sử dụng network namespaces để cung cấp nhiều router ảo độc lập, mà không ảnh hưởng đến các router khác hoặc cơ chế định tuyến của compute node mà nó được đặt trên.
  

### Một số câu lệnh làm việc với network namespace.
- Liệt kê các network namespace:
```
ip netns list
```
```
[root@os-controller ~]# ip netns list
qrouter-c1e9e77b-41ff-4c88-b28a-4460ca8df627 (id: 2)
qdhcp-4fa7b8b7-9c83-48c8-b0f2-7a088f95342f (id: 1)
qdhcp-0fb7bb30-ae0d-4bc6-8455-2871f72f1b74 (id: 0)
```

- Thực thi câu lệnh trong namespace:
```
ip netns exec <namespace> <command>
```
```
[root@os-controller ~]# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    100    0        0 eth0
192.168.30.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0
192.168.40.0    0.0.0.0         255.255.255.0   U     101    0        0 eth1
[root@os-controller ~]# ip netns exec qdhcp-0fb7bb30-ae0d-4bc6-8455-2871f72f1b74 route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    0      0        0 ns-aa407ac9-74
link-local      0.0.0.0         255.255.0.0     U     0      0        0 ns-aa407ac9-74
192.168.50.0    0.0.0.0         255.255.255.0   U     0      0        0 ns-aa407ac9-74

```

## 3.2. Kiến trúc neutron

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.04.png">

Openstack Neutron là một dịch vụ độc lập mà triển khai một số tiến trình trên một số lượng các node. Các tiến trình này tương tác với nhau và với các dịch vụ Openstack khác. Tiến trình chính của Neutron là neutron-server, một daemon Python expose Openstack Networking API và truyền yêu cầu của người dùng đến một plug-ins phù hợp để xử lý sau đó.

Các thành phần của Openstack networking:

**neutron-server (neutron-server and neutron-*-plugin)**: Dịch vụ này chạy trên network node để cung cấp Networking API và phần mở rộng của nó. Nó cũng thực thi mô hình mạng và địa chỉ ip trên từng port. Dịch vụ neutron-server yêu cầu truy cập gián tiếp đến database thông qua các plugin - mà giao tiếp với database sử dụng AMQP.

**plugin agent(neutron-*-agent)**: chạy trên mỗi compute node để quản lý cấu hình của switch ảo trên đó. Plug-in sẽ được dùng để xác định agent nào đang chạy. Dịch vụ này yêu cầu truy cập message queue và các yêu cầu khác phụ thuộc vào plug-in nào được sử dụng.

**DHCP-Agent(neutron-l3-agent)**: Cung cấp dịch vụ DHCP cho mạng của khách hàng. Trên mọi plug-ins thì agent này đều có nhiệm vụ giống nhau là quản lý cấu hình DHCP. DHCP agent yêu cầu truy cập message queue và các yêu cầu khác tùy vào plug-in.

**L3 agent(neutron-l3-agent)**: Cung cấp các cấu hình mạng ở layer 3/Nat forwarding để mạng ngoài truy cập, giao tiếp với mạng khách hàng. L3 agent yêu cầu truy cập message queue và các yêu cầu khác tùy vào plug-in.

**network provider service(SDN server/services)**: Cung cấp thêm dịch vụ cho networking. Dịch vụ SDN có thể giao tiếp với *neutron-server*, *neutron-plugin* và *neutron-agent* thông qua các kênh giao tiếp như REST-API.


## 3.3. Neutron Agent

- Một agent trong neutron đảm nhiệm các nhiệm vụ khác nhau để tác động tới các mạng ảo . Trong neutron gồm các agent cơ bản sau : neutron-dhcp-agent, neutron-l3-agent, neutron-metering-agent, and neutron-lbaas-agent,
- Các agent cơ bản khi khi triển khai ` self-service network`
```
[root@controller nova]# openstack network agent list
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| b68cd06e-384f-47d7-88e4-dd5a6a85796c | Linux bridge agent | compute1   | None              | :-)   | UP    | neutron-linuxbridge-agent |
| c4eb82a1-d86a-4eb8-a230-f62b567d4df8 | DHCP agent         | controller | nova              | :-)   | UP    | neutron-dhcp-agent        |
| ce13fbcc-e0e6-4b55-87cd-7bdfe58ce357 | L3 agent           | controller | nova              | :-)   | UP    | neutron-l3-agent          |
| e2279058-9cad-4e05-801d-51a8f16b6850 | Metadata agent     | controller | None              | :-)   | UP    | neutron-metadata-agent    |
| f7fc3ab5-35c5-4968-a349-79ba6820d25a | Linux bridge agent | controller | None              | :-)   | UP    | neutron-linuxbridge-agent |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
``` 

### 3.3.1 : ML2 plugin , agent 

- Modular Layer 2 (ml2) cung cấp một framework cho phép neutron tương tác với các hạ tầng Layer 2 hiện đang có trong các DC. Ml2 framework gồm có 2 driver riêng biệt
	- Type driver : giúp neutron xác đinh được công nghệ sử dụng : Ví dụ như VLAN . Với mỗi kiểu network được quản lý bởi ML2 Type Driver , xác định trạng thái mạng cụ thể và chịu trách nhiệm cho các segment layer 2
	- Mechanism drivers : giúp neutron xác định rõ ràng các làm việc với một loại mạng cụ thể . Type driver cung cấp mạng quản lý sau đó  Mechanism driver sẽ đến các device ở ngoài để làm việc với một mạng nào đó . 

  <img src="https://github.com/lean15998/Openstack/blob/main/images/07.03.png">
	
- L2 agent serves phục vụ khả năng làm việc với Layer 2. Thường năm trên Network Node và trên mỗi Compute Node 

### 3.3.2 : L3 Agent 
- Cung cấp khả năng làm việc với các dịch vụ Layer 3 :  virtual Routers và Floating IP

- Yêu cầu có sẵn một L2 Agent 


### 3.3.3. DHCP agent

- Đảm nhiệm nhiệm vụ DHCP . 
- Yêu cầu có sẵn một L2 Agent 

### 3.3.4. Meta Data agent

- Cung cấp khả gửi các cloud init data tới các instance thông tin network
-  Yêu cầu có sẵn một L2 Agent

# 4. Neutron Traffic Flow trong Linux Bridge

## 4.1. Provider network 

### 4.1.1 . North - South : instance with IP Floating

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.05.png">

Quá trình truyền tải  trên compute node : 

- B1 : Instance interface sẽ gửi packet đến cổng tương ứng của instance trên provider bridge (1) thông qua kết nối `veth` ( 2 )
- B2 : Security group trên LB sẽ kiểm soát traffic (3)
- B3 : Các sub-interface trên provider bridge sẽ chuyển các frame đến physical interface ( có thể là VLAN subport hoặc flat ) (4 )
- B4 : Physical interface sẽ (5 ) chuyển tiếp các traffic ra ngoài switch ngoài hạ tầng ( có thể gắn VLAN_ID hoặc no_tag ) (6 )
- B5.: Khi đến swtich vật lý ( 6 ) các frame sẽ được bỏ VLAN và chuyển đến router (  7 ) 
- B6. Router nhận packet từ provider network sau đó sẽ gửi ra mạng ngoài ( 8 ) 


### 4.1.2. East - West - same network

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.06.png">

Các instance thuộc các compute node khác nhau  liên hệ với nhau trên cùng một network
Đường đi của của các instance
- B1 :  instance  interface (1 ) sẽ gửi các packet đến tun port tương ứng trên provider bridge (2) nhờ vào `veth` pair
- B2 :  Security group (3 sẽ làm việc kiểm soát các packet 
- B3.  Các sub_interface  (4 ) trên bridge sẽ gửi các packet tới physical interface ( 5 ) - có thể VLAN_port hoặc no_tag
- B4.  Physical interface ( 5 ) sẽ gắn VLAN_ID tương ứng với VLAN_PORT hoặc no_tag sau đó gửi frame đến swtich ( 6 )
- B5. Switch sẽ gửi frame từ compute 1 đến compute 2 ( 7 )
- B6. Physical interface ( 8 )  trên Compute sẽ bỏ VLAN_ID ( hoặc không ) sau đó gửi đến VLAN_sub interface tương ứng ( 9 ) trên provider bridge
- B7. Security group sẽ kiểm soát packet ( 10 )
- B8. Provider bridge gửi packet đến instance interface

### 4.1.3. East-west - different network

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.07.png">

Các instance thuộc các compute node khác nhau  liên hệ với nhau khác network
- Trên Compute 1 
	- B1. instance interface ( 1 ) sẽ gửi packet đến đến port trên provider bridge nhờ `veth` pair ( 2 )
	- B2. Security group (  3 ) sẽ  kiểm soát traffic
	- B3. VLAN sub_interface hoặc no_vlan (4 ) trên provider bridge packet đến physical interface 
	- B4. Physical interface ( 5 ) sẽ thêm VLAN_ID vào frame sau đó gửi frame đến switch vật lý  ( 6 ) 

- Trên mạng vật lý
	- B1. Switch sẽ bỏ VLAN_ID trên sau đó gửi packet đến router ( 7 ) 
	- B2. Router gửi packet từ provider network 1 ( 8 ) sang provider network 2 ( 9 ) 
	- B3. Router sẽ gửi packet đến swtich ( 10 ) 
	- B4. Swtich thêm VLAN_ID hoặc no_tag sau đó gửi frame đến compute 2 ( 11 )
	
- Trên Compute 2 :
	- B1.  Trên physical interface ( 12 )sẽ bỏ VLAN_ID và gửi packet đến sub_port trên provider bridge ( 13
	- B2. Security group sẽ kiểm soát traffic ( 14 )
	- B3. Provider bridge (15 ) sẽ gửi packet đến port của instance 2 ( 16 )

## 4.2. Self-service Network

- Trong self-service các instance sẽ sử dụng IPv4 Private . Để  truy cập được interface , networking service sẽ làm nhiệm vụ SNAT ( Source Network Addresss Translation ) để  truy cập ra mạng  external . . Để từ các mạng có thể truy cập , các instance yêu cầu có một floating IP . Networking service thực hiện DNAT ( desnation network address translation ) từ IP Floating sang IP self-service 


### 4.2.1. North-south - instance with Fixed IP V4 

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.08.png">

Với các instance kèm IP v4 Floating, trên network node sẽ thực hiện SNAT để self-service có thể giao tiếp với mạng ngoài 

Đường đi của instance đi ra internet :
- Trên compute node :
	- B1 :  instance interface ( 1 )  sẽ gửi packet đến port tương ứng đến bridge sử dụng `veth` pair ( 2 ) 
	- B2 : Security group ( 3 ) sẽ đảm nhiệm filter traffic (3 )
	- B3 : Self-service bridge sẽ chuyển packet tới VXLAN interface trên bridge ( 4 ) kèm VNI
	- B4 : Physical interface ( 5 ) cho phép mạng Overlay XVLAN chuyển packet lên network node ( 6 ) 

- Trên network node :
	- B1 : Physical network ( 7 ) nhận packet từ Overlay VXLAN Interface  sau đó chuyển lên Self-service bridge port ( 8 ) 
	- B2 : Self-service bridge( 9 )  sẽ gửi packet đến router namespace .( 10 ) Với IPv4. router namespace sẽ thực hiện SNAT, thay đổi IP nguồn thành Router IP của Provider Network  ( 11 ) . 
	- B3 : Router gửi packet đến provider bridge ( 12 )
	- B4 : VLAN sub_interface trên provider bridge sẽ gửi packet đến provider physical network interface . 
	- B5 : Provider physical network thêm VLAN Tag và đi ra internet  

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.09.png">


### 4.2.2. North-South : instance with floating IP 

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.10.png">

Quá trình một host từ internet gửi packet cho instance

- Trên network node :
	- B1: Từ mạng vật lý ( 1 ) gửi packet vào provider physical interface ( 2 ) 
	- B2: Provider physical interface ( 3 ) sẽ bỏ các VLAN_TAG và sẽ gửi các packet vào VLAN Sub_interface tương ứng  trên provider bridge ( 4 ) 
	- B3 : Provider bridge sẽ chuyển packet sang self-service router gateway port ( 5 ) 
		- Với IPv4, router đảm nhiệm thực hiện DNAT để thay đổi địa chỉ đích IP thành IP Floating của instance trên self-service network . ( 6 ) 
	- B4 : Router chuyển gói tin đến tin đến self-service bridge port ( 7 )
	- B5 : Self-service bridge gửi packet đến VXLAN Interface kèm theo VNI  ( 8 )
	- B6 : Physical network interface( 9  )  gửi packet đến compute node thông qua Overlay network ( 10 )

Trên compute node:
	- B1 : Physical interface ( 11 )  send packet tới VXLAN interface ở self-server bridge ( 12 ) 
	- B2 : Security group đảm nhiệm filter packet ( 13 )
	- B3 : Self-service bridge chuyển packet đến instance port



### 4.2.3 East-west - same network


<img src="https://github.com/lean15998/Openstack/blob/main/images/07.11.png">

Trên Compute 1 :
- B1 : Instance interface ( 1 )  chuyển packet đến self-service port tương ứng  ( 2 )
- B2 : Security group ( 3 ) đảm nhiệm filter data 
- B3 : Self-service bridge ( 4 ) chuyển tiếp packet tới VXLAN Interface kèm theo VNI
- B4 : Physical interface  ( 5 ) chuyển tiếp packet tới compute 2 nhờ overlay network ( 6 ) 

Trên Compute 2 :
- B1 : Trên physical ( 7 )  interface cho phép XVLAN interface chuyển tiếp packet tới XVLAN interface ( 8 ) 
- B2 : Security group ( 9 ) đảm nhiệm filter data
- B3 : Self-service bridge  ( 10 ) chuyển data tới instance interface ( 11 ) 


### 4.2.3 East-west - different network

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.12.png">

### 4.3. Một số quy ước trong Neutron OVS

**Trên compute node**
-  Linux bridge: qbr-ID 
-  Linux bridge nằm giữa VM và br-int, gồm 2 port:
	-   port tap gắn với VM: tap-ID
	-   port veth pair gắn với br-int: qvb-ID
-   Br-int :
	-   port veth pair gắn với linux bridge: qvo-ID
	-   port patch gắn với br-tun

Trên 1 network thì các port của các thiết bị này có chung ID là ID của network đó.

**Trên network node**
-   Br-int: cung cấp router ảo và DHCP cho instance. gồm các port: 
	-   port tap gắn với DHCP namespace: tap-ID    
	-   port qr gắn với router namespace: qr-ID    
-   Br-ex: cung cấp external connection. Gồm port qg gắn với router namespace: qg-ID

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.13.png">

# 5. Tìm hiểu VXLAN

# 6. Tìm hiểu OVS trong OPS

## 6.1. OpenvSwtich trong OPS

- Trong OVS gồm các khái niệm sau :
	- br-init (integration Bridge)  : 2 các VM sử dụng các virtual interface để kết nối đến birdge
	- br-eth ( ethernet bridge ) : để xác định frame có sử dụng VLAN_ID trước khi chuyển tiếp các frame 
	- br-tun ( tunnel interface ) : thêm tunnel type vào header
	- br-ex ( external bridge ) : được sử dụng để kết nối ra các mạng external. mạng external này là mạng ngoài với các mạng đứng sau br-ex, không có nghĩa hoàn toàn là IP Public
	- veth : sử dụng để kết nối các bridge ( OVS to OVS, LB to OVS ) 2 


<img src="https://github.com/lean15998/Openstack/blob/main/images/07.14.png">


## 6.2. OpenVswitch trong Openstack

### 6.2.1 : Môi trường Multi VLAN trên Compute Node

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.15.png">

Trong mô hình trên bao gồm :
- qbr-ID: một Linux Bridge đứng giữa VM và br-init, bao gồm 2 port : 
	- port tap - vnet : là TAP-driver, gắn trực tiếp với VM Network Card
	- port veth -  qvb : cầu nối giữa Linux Bridge và Br_intu

- OVS br-init : gồm có 2 port :
	- port veth - qvo : cầu nối với Linux Bridge 
	- port veth : cầu nối với br-external

- OVS br-ex :  gồm 2 port :
	- port br-eth : cầu nối với br-init
	- port eth1 : physical interface của compute node


### 6.2.2. Mô hình VXLAN - Self Service

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.16.png">

Trong mô hình trên bao gồm :

**Trên Compute Node** : 
- qbr : Linux Bridge gồm có 2 port
	- port TAP - vmet : kết nối với VM
	- port veth - qvb : kết nối với br-int

- br-int : OVS gồm có 2 port
	- port veth - qvo : kết nối với Linux Bridge - qbr
	- port veth - patch tun: kết nối với br-tun

- br-tun : OVS gồm có 2 port
	- port veth - patch-int : kết nối với br-int
	- port vxlan : kết nối đến overlay network

**Trên Network Node**

- br-tun : OVS gồm có 2 port
	- port vxvlan : kết nối với overlay nework
	- br veth - br tun : kết nối đến br init

- br-init : OVS bao gồm 3 port :
	- port	TAP : kết nối đến namespace DHCP
	- port qr, qg : kết nối đến namespace Router

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.17.png">

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.18.png">

- br-provider : OVS gồm có 2 port
	- port veth : kết nối tới router
	- por ex : kết nối với Physical Interface

# 7. Tìm hiểu flow packet khi sử dụng OpenvSwitch

## 7.1. Môi trường giả lập

- Mô hình Bắc - Nam : liên hệ giữa các instance và mạng ngoài ( hạ tầng mạng vật lý )
- Mô hình Đông - Tây : liên hệ giữa các instance với nhau cùng mạng hoặc khác mạng. 
- Giả định môi trường mạng như sau :
	- Provider 	- VLANID 101
	- Self-service network 1 - VNI 101
	- Self-service network 2 - VNI 102
	- Self-service route
	- instance 1,2 


## 7.2. Mô hình Self-Service

### 7.2.1 . Bắc - Nam , sử dụng fixed IP

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.19.png">

- Trên mô hình này, network node sẽ thực hiện thực hiện Source NAT để gửi traffic của các instance ra mạng external

- Trên Compute Node

	- B1 :  Packet từ instance interface ( 1 ) được chuyển tiếp đến veth pair ( 2 ) trên Linux Bridge
	- B2 : Security group trên Linux Bridge sẽ đảm nhiệm filter (3  )
	- B3 :  Linux Bridge (4 ) chuyển tiếp các frame đến OVS integration bridge sử dụng veth pair
	- B5 : Tại đây ( 5 ) integration bridge thêm tag VNI 101, xác định Tunnel ID
	- B6 : OVS integration bridge veth port ( 6 ) sẽ chuyển các packet đến OVS Tunnel Bridge veth port ( 7 )
	- B7 : OVS tunnel bridge sẽ đóng gói các packet với VNI 101 ( 8 ) 
	- B8 : Physical interface ( 9 ) cho phép mạng overlay chuyển tiếp các packet đến network node ( 10 

- Trên Network Node
	- B1 : Trên physical interface ( 11 ) của network node cho phép các packet từ overlay network đi vào OVS tunnel bridge ( 12 )
	- B2 : OVS Tunnel sẽ thêm Tunnel ID , và gắn một VLAN ID cho các packet này
	- B3 : OVS Tunnel veth port ( 13 ) sẽ gửi packet tới OVS integration veth port ( 14 ) 
	- B4 : OVS integration bridge port ( 15 ) sẽ bỏ các VLAN ID và chuyển tiếp tới router namespace ( 16 ) 
	- B5 : Đối với IPv4  : SNAT sẽ được thực hiện tại đây , thay đổi địa chỉ IP của self-service network thành IP của provider network ( 17 )
	- B6 : Router ( 18 ) chuyển tiếp packet OVS integration bridge , sau đó sẽ thêm VLAN ID vào packet 
	- B7 :  OVS integration bridge patch port ( 19 ) sẽ forward packet tới OVS provider bridge phy-br-provider ( 20 ) 
	- B8 :  OVS provider  bridge port( 21 ) sẽ forward packet ra physical interface ( 22 )
	- B9 : Physical interface sẽ gửi packet ra ngoài ( 23 ) 

### 7.2.2 : Bắc - Nam sử dụng Floating IP

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.20.png">

- Sử dụng SNAT để các máy ảo giao tiếp ra ngoài và DNAT để mạng ngoài giao tiếp với instance
- Trường hợp dưới đây từ một máy từ mạng ngoài liên hệ với instance

- Trên Nodework Node

	- B1 : Từ mạng ngoài ( 1 ) gửi packet vào provider physical interface ( 2 ) 
	- B2  : Provider physical interface ( 3 ) chuyển tiếp packet đến OVS provider bridge, sau đó sẽ lấy VLAN ID của packet
	- B3 : OVS provider bridge port ( 4 ) sẽ forward packet sang OVS integration bridge port ( 5 ) 
	- B5 : OVS integration bridge port ( 6 ) sẽ remove internal VLAN và chuyển packet đến router namepsace. Sau đó thực hiện Destination NAT  ( 7 ) 
	- B6 : Router ( 8 ) chuyển tiếp các packet sang OVS integration bridge ( 9 ) 
	- B7 : Tại OVS intergration bridge sẽ thêm các VLAN ID , sau đó sẽ tìm Tunnel ID tương ứng
	- B8 : OVS intergration bridge ( 10 ) chuyển các packet tới OVS tunnel bridge ( 11 ) 
	- B9  : OVS tunnel bridge ( 12 ) sử dụng VNI cho header các packet 
	- B10 : Physical interface sẽ cho phép các overlay network ( 13 ) gửi các packet đến compute node ( 14 )

- Trên Compute Node :
	- B1  : Physical interface ( 15 ) sẽ chuyển tiếp các packet đến overlay network ( 16 )
	- B2 : OVS tunnel  bridge sẽ sẽ sử dụng VLAN ID cho Tunnel ID tương ứng 
	- B3 : OVS tunnel bridge ( 17 ) sẽ chuyển các packet sang OVS ingrateion bridge  ( 18 ) sử dụng `patch-int` 
	- B4 : OVS integration bridge loại bỏ VLAN 
	- B5 : OVS integration bridge sử dụng securtity group ( 19 ) để filter các packet sau đó gửi  sang Linux Bridge ( 20 ) thông qua veth pair
	- B6 : Securtiy group sẽ thực hiện filtering ( 21 )
	- B7 : Security group ( 22 ) sẽ chuyển tiếp goi tin đến instance interface ( 23 )  

### 7.2.3.  Đông - Tây : các instance cùng 1 mạng 

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.21.png">

- Trên Compute 1 :
	- B1 : instance interface  ( 1 ) forward các packet tới security group trên ( Linux Bridge )  ( 2 ) thông qua `veth` pair
	- B2 : securtity group ( 3 ) đảm nhiện filter tại đây
	- B3 : Linux Bridge  port( 4 ) forward packet tới OVS integration ( 5 )nhờ `veth` pair
	- B4 : OVS  ingration bridge thêm VLAN ID vào packet
	- B5 : OVS integration bridge thay VLAN ID bằng Tunnel ID
	- B6 : OVS integration bridge patch port ( 6 ) forward packet tới OVS Tunnel bridge patch port ( 7 ) 
	- B7 : OVS tunnel bridge ( 8 ) gắn VNI vào packet
	- B8 : Underlay nework ( 9 ) cho phép overlay network ( 10  )  chuyển packet đến network node

 -  Trên Compute 2
	- B1 : Underlay network  ( 11) cho phép overlay networking ( 12 ) forward tới OVS bridge tunnel 
	- B2 : OVS tunnel bridge thêm một Tunnel ID vào packet 
	- B3 : OVS tunnel bridge thay đổi Tunnel ID bằng VLAN ID tương ứng.
	- B4 : OVS tunnel bridge patch port ( 13 ) forward packet tới OVS integratation bridge `patch tun` port ( 14 ) 
	- B5 : OVS integration bridge bỏ VLAN ( 15 ) forward packet đến Linux bridge `veth` port ( 16 )
	- B6 : Security Group đảm nhiệm filter packet ( 17 ) 
	- B7 : Linux bridge veth port ( 18 ) forward packet đến instance interface ( 19 ) 



### 7.2.4.  Đông - Tây : các instance khác mạng


<img src="https://github.com/lean15998/Openstack/blob/main/images/07.22.png">

- Trên Compute Node : 
	- B1 : instance interface ( 1 ) forward packet đến Linux Bridge port ( 2 ) thông qua `veth` pair
	- B2 : Security group ( 3 ) sẽ đảm nhiệm filter các packet 
	- B3 : Linux bridge port ( 4 ) sẽ forward packet đến OVS integration ( 5 ) thông qua `veth` pair
	- B4 : OVS integration bridge sẽ thêm VLAN ID vào các packet
	- B5 : OVS integration bridge thay đổi các VLAN ID thành Tunnel ID
	- B6 : OVS integration bridge `patch-tun` ( 6 ) forward packet tới OVS tunnel bridge ( 7 ) `patch-int`
	- B7 : OVS tunnel bridge ( 8 ) gán VNI vào các packet
	- B8 : Underlay network ( 9 ) sẽ cho phép overlay network gửi các packet đến network node ( 10 ) 


- Trên Network Node
	- B1 : Underlay network interface ( 11 ) cho phép overlay network forward packet tới OVS tunnel bridge ( 12 )
	- B2 : OVS tunnel bridge loại bỏ VNI và tag Tunnel ID cho packet
	- B3 : OVS tunnel bridge loại bỏ tag Tunnel  ID bằng VLAN ID
	- B4 : OVS tunnel bridge `patch port` ( 13 )  forward packet tới OVS integration bridge `patch-tun` ( 14 )
	- B5 : OVS intergation bridge ( 15 ) xóa bỏ VLAN ID các packet và forward lên interface của self-service router ( 15 )
	- B6 : Router forward packet sang next-hop , gateway của mạng thứ 2  thông qua router interface( 17 ) 
	- B7 : Router forward packet đến OVS integration bridge port self-service ( 2 ) 
	- B8 :  OVS integration bridge `patch-tun` ( 19 ) forward packet sang OVS tunnel bridge `patch-ini ` patch port ( 20 )
	- B9 : OVS tunnel bridge ( 21 ) tag VNI cho các packet
	- B10 : Underlay network ( 22 ) sẽ cho phép overlay network ( 23 ) forward packet về compute node

- Trên Compute Node
	- B1 : Underlay network ( 24 ) cho phép overlay network forward packet ( 25 ) tới các OVS Tunnel Bridge
	- B2 : OVS Tunnel Bridge gở bỏ VNI và tag Tunnel ID
	- B3 : OVS Tunnel Bridge thay thế Tunnel ID thay thế bằng VLAN ID
	- B4 : OVS Tunnel Bridge port ( 26 ) forward packet tới OVS integration bridge sử dụng patch port ( 27 )
	- B5 : OVS integration sẽ remove VLAN trên các packet 
	- B6 :  OVS integration bridge port ( 28 ) forward packet tới tới Linux Bridge ( 29 ) sử dụng `veth` pair
	- B7 : Security group ( 30  ) sẽ filer các packet
	- B8 : Linux Bridge ( 31 ) sẽ forward packet tới các instance interface ( 32 ) sử dụng `veth` pair


## 7.3. Mô hình Provider


### 7.3.1. Bắc Nam 


<img src="https://github.com/lean15998/Openstack/blob/main/images/07.23.png">


- Trên Compute 1 : 
	- B1 : instance interface  ( 1 ) forward packet đến Linux Bridge port ( 2 ) nhờ  `veth` pair
	- B2 : Security group ( 3 ) đảm nhiệm filter các packet 
	- B3 : Security group OVS bridge port ( 4  ) forward packet tới OVS integration bridge port ( 5 ) nhờ `veth` pair
	- B4 : OVS integration bridge tag VLAN ID tới packet
	- B5 : OVS integration bridge patch port ( 6 ) forward packet đến OVS provider bridge patch port ( 7 )
	- B6 : OVS provider bridge Tag VLAN external cho packet
	- B7 : OVS provider bridge port ( 8 ) forward packet tới physcal interface
	- B8 : Physical interface ( 9) forward packet tới hạ tầng mạng ( 10 )

- Hạ tầng mạng ngoài : 
	- B1 : Switch bỏ VLAN ID và forward packet lên Router ( 11 )
	- B2 : Router forward forward data ra các mạng ngoài ( 12 ) và forward đến switch ( 13 ) 

### 7.3.2 : Đông - Tây : cùng mạng

- Trên Compute 1 : 
	- instance interface ( 1 ) forward data sang bridge instance port ( 2 )thông qua `veth` pair
	- Security group ( 3 ) đảm nhiệm filter các packet
	- Linux bridge port ( 4 ) forward packet sang OVS integration bridge port ( 5 ) sử dụng `veth` pair
	- OVS integration tag internal VLAN_ID vào các packet
	- OVS integration bridge patch port ( 6 ) forward packet sang OVS integration bridge patch port ( 7 )
	- OVS provider bridge sử dụng VLAN_ID external thay thế cho internal VLAN_ID
	-  OVS provider bridge port  ( 8 )forward packet sang physical interface ( 9 ) 
	- Physical interface forward packet đến switch vật lý ( 10 )
	
- Trên Switch 
	- Forward packet từ compute node 1 sang compute node 2 

- Trên Compute 2 : 
	- Physical interface network interface ( 12 ) forward packet tới OVS provider port ( 13 )
	- OVS provider bridge patch port ( 14 ) forward packet tới OVS intergration bridge  patch port ( 15 )
	- OVS integration bridge định nghĩa VLAN_ID 
	- OVS integration bridge port ( 16 ) forward packet đến  Linux Bridge port ( 17  ) sử dụng `veth` pair
	- Securtiy group ( 18 ) đảm nhiệm filter các packet
	- Linux brige veth port ( 19 ) forward các packet sang instance interface ( 20 ) sử dụng `veth` pair


### 7.3.3. Đông -  Tây : khác mạng

<img src="https://github.com/lean15998/Openstack/blob/main/images/07.24.png">

- Trên Compute Node
	- B1 : Instance 1 interface ( 1  ) forward packet sang Linux Bridge veth port ( 2 ) 
	- B2 : Securtiy group rule ( 3 ) sẽ đảm nhiệm filter package
	- B3 :  Linux Bridge port ( 4) forward packet đến OVS integration bridge  veth port ( 5 )
	- B4 : OVS integration bridge thêm VLAN vào các packet 2
	- B5 : OVS integration bridge  
	- B6 : OVS provider bridge sử dụng VLAN_ID external thay thế cho local VLAN_ID
	- B7 : OVS provider patch port ( 6 ) forward packet sang OVS provider bridge patch port ( 7 )
	- B8 : OVS provider bridge port ( 8 ) forward packet tới physical interface ( 9 ) 
	- B9 : Physical interface forward packet tới switch vật lý ( 10 ) 
	
- Trên Switch
	- B1 : Switch bỏ các VLAN_ID khỏi packet và forward tới router ( 11 )
	- B2 : Router sẽ forward tới các cổng ( 12) để forward packet sang mạng 2 ( 13 )
	- B3 : Router forward các packet tới switch ( 14 )
	- B4 : Switch tag VLAN vào packet và forward tới Compute Node ( 15 )

- Trên Compute Node
	- B1 : Physical interface ( 16 ) forward packet tới OVS provider bridge port ( 17 )
	- B2 : OVS provider bridge patch port ( 18 ) forward packet tới OVS integration bridge port ( 19 )
	- B3 : OVS integration bỏ VLAN_ID và tag local VLAN_ID
	- B4 : OVS integration port ( 20 ) bỏ VLAN và forward đến Linux Bridge ( 21 )
	- B5 : Linux bridge sẽ đảm nhiệm filter packet ( 22 ) 
	- B6 : Linux bridge veth port ( 23 ) foreward packet tới instance 2 interface ( 24 )


# 8. Làm việc vói neutron

## 8.1. Làm việc với neutron qua CLI


### 8.1.1. Khởi tạo Network , Router, Port, Floating IP

- Khởi tạo external network


- Khởi tạo Subnet cho external network 


- Khởi tạo một Sefl-Service Network


- Khởi tạo subnet cho self-service network


-  Khởi tạo một router


- Xem thông tin router vừa khởi tạo



- Liệt kê các port
 
 
- Xem thông tin cụ thể của một Port

- Khởi tạo **Floating IP ** , gắn Floating IP đến cho các instance với các IP từ ISP để có thể truy cập từ ngoài internet sử dụng DNAT



### 8.1.2. Xóa Router, Subnet, Network 

####  Xóa Self-Service Subnet đang Binding Router
- **Để xóa một subnet đang gắn vào một router cần xóa subnet đó khỏi router để xóa các port đang đc binding**

-  Xem router nào đang chứa subnet

- Xóa Subnet ra khởi router


#### Xóa  Self-service Network

- Khi xóa một Network thì sẽ xóa các Subnet đang binding vào


### 8.1.3. Quản lý Security Group
- Security Group đảm nhiệm nhiệm vụ filter như `iptables` 

- Xem thông tin của một security group

Như vậy đã có một sececurity đã được tạo trên project admin

- Khởi tạo một rule mới
















